---
title: "Anova Test"
author: "Hadi"
date: "2024-04-03"
output: html_document
---

load libraries
```{r}
library(dplyr)
library(lubridate)
library(ggplot2)
library(purrr)
library(tidyverse)
library(stringr)
library(reshape2)
library(viridis)
library(fds)
library(tidyr)
library(viridis)
library(transport)
library(viridis)
library(gridExtra)
library(kableExtra)
library(lmtest)
library(tseries)
library(feather)
library(grid)
```


```{r}
# Load the labelled dataset

California <- readRDS(".../California.rds")

```


```{r}

#MTY-YEARS

MTY_YEARS_intervals <- cut(California$`MTY-YEARS`,
                           breaks = c(quantile(California$`MTY-YEARS`, na.rm = TRUE)), na.rm = TRUE,
                           labels =  c(" Less than 8", "8_12.3", "12.3_17", "Higher than 17"), include.lowest = TRUE)

California <- California %>% mutate(MTY_YEARS_int = MTY_YEARS_intervals)

California$MTY_YEARS_int <- paste("Maturity_OID", 
                                         California$MTY_YEARS_int, sep = " : ")



California <- California %>%
  mutate(
    Iss_pri._spread = case_when(
      is.na(ISSUE_PX) ~ NA_character_,
      ISSUE_PX == 100 ~ "At Par",
      ISSUE_PX < 100 ~ "At Discount",
      ISSUE_PX > 100 ~ "At Premium"
    )
  )


# Callability
for (i in seq_len(nrow(California))) {
  if (California$CALLABLE[i] == "FALSE") {
    California$CALLABLE[i] <- "Non-callable"
  } else {
    California$CALLABLE[i] <- "Callable"
  }
}

# Coupon rate
cpn_intervals <- cut(California$CPN,
                     breaks = c(0, 2.99, 4.999, 15),
                     labels = c("0_3(%)", "3_5(%)", "5_8.5(%)"))

California <- California %>%
  mutate(CPN_Group = cpn_intervals)

# Tax
California$MUNI_TAX_PROV <- paste("Tax", California$MUNI_TAX_PROV, sep = " : ")

# AMT_ISSUED (log transform and binning)
California$log_AMT_ISSUED <- log(California$AMT_ISSUED)

Amt_issued_intervals <- cut(
  California$log_AMT_ISSUED,
  breaks = quantile(California$log_AMT_ISSUED, na.rm = TRUE),
  labels = c("Less than 14", "14_15", "15_16", "Higher than 16"),
  include.lowest = TRUE
)
California <- California %>%
  mutate(Amt_iss_int = Amt_issued_intervals)

# YIELD_ON_ISSUE_DATE
Y_on_Iss_Date_intervals <- cut(
  California$YIELD_ON_ISSUE_DATE,
  breaks = quantile(California$YIELD_ON_ISSUE_DATE, na.rm = TRUE),
  labels = c("Less than 1.7", "1.7_2.4", "2.4_3.2", "Higher than 3.2"),
  include.lowest = TRUE
)
California <- California %>%
  mutate(Y_OID = Y_on_Iss_Date_intervals)

# DUR_ADJ_MID
DUR_ADJ_MID_intervals <- cut(
  California$DUR_ADJ_MID,
  breaks = quantile(California$DUR_ADJ_MID, na.rm = TRUE),
  labels = c("Less than 2.8", "2.8_4.8", "4.8_7", "Higher than 7"),
  include.lowest = TRUE
)
California <- California %>%
  mutate(DAM = DUR_ADJ_MID_intervals)

# SPREAD_AT_ISSUANCE_TO_WORST
Sp_at_iss_intervals <- cut(
  California$SPREAD_AT_ISSUANCE_TO_WORST,
  breaks = quantile(California$SPREAD_AT_ISSUANCE_TO_WORST, na.rm = TRUE),
  labels = c("Less than 17", "17_57", "57_100", "Higher than 100"),
  include.lowest = TRUE
)
California <- California %>%
  mutate(S_AT_Iss = Sp_at_iss_intervals)

# Replace NAs with "NA" in all interval columns
interval_cols <- c("S_AT_Iss", "DAM", "Y_OID", "Amt_iss_int", "MTY_YEARS_int", "Iss_pri._spread")
for(col in interval_cols) {
  California[[col]] <- as.character(California[[col]])
  California[[col]][is.na(California[[col]])] <- "NA"
}



# Rename maturity column
colnames(California)[43] <- "Maturity_OID"
colnames(California)[44] <- "Pricing_TYP"
colnames(California)[45] <- "CPN_range"
colnames(California)[47] <- "Issued_Amt"
colnames(California)[48] <- "Y_OID"
colnames(California)[49] <- "DAM"
colnames(California)[50] <- "S_OID"



California <- California_1 %>% dplyr::select(ID_CUSIP, Date, S1, Maturity_OID, MUNI_TAX_PROV,
                                    Y_OID, S_OID, DAM, CALLABLE, Issued_Amt, 
                                    CPN_range, Pricing_TYP)

#saveRDS(California,".../California_Anova.rds" )


```



ANOVA TEST 
```{r}



attributes <- c("MUNI_TAX_PROV","Pricing_TYP", "CPN_range",
                "S_OID","Y_OID", "DAM", "CALLABLE", "Issued_Amt")
ds <- list()
ds_maturity <- California %>%
    filter(Date > as.Date("2016-12-31")) %>%
    group_by(Date, Maturity_OID) %>%
    summarise(S1_med = median(S1), .groups = 'drop') %>%
    ungroup()

for (i in 1:length(attributes)) {
  ds[[i]] <- California %>%
    filter(Date > as.Date("2016-12-31")) %>%
    group_by(Date, Maturity_OID, !!sym(attributes[i])) %>%
    summarise(S1_med = median(S1), .groups = 'drop') %>%
    ungroup()
}
# Combine all data frames into one
ds <- bind_rows(ds)




#=============================ANOVA====================================



maturities <- c(" Less than 8", "8_12.3", "12.3_17", "Higher than 17")
attributes <- c("MUNI_TAX_PROV","Pricing_TYP", "CPN_range",
                "S_OID","Y_OID", "DAM", "CALLABLE", "Issued_Amt")
aov_t_data <- list()
anov_test_1 <- list()

#Group data according to maturity and attributes
for (i in 1:length(maturities)) {
  aov_t_data[[i]] <- vector("list", length(attributes))
  anov_test_1[[i]] <- vector("list", length(attributes))
  
  for (j in 1:length(attributes)) {
    aov_t_data[[i]][[j]] <- California %>%
      filter(Date > as.Date("2016-12-31")) %>%
      group_by(Date, Maturity_OID, !!sym(attributes[j])) %>%
      filter(Maturity_OID == maturities[i]) %>%
      summarise(S1_med = median(S1), .groups = 'drop') %>%
      ungroup()
    
    #Anova test for S_1
    aov_t_data[[i]][[j]][[attributes[j]]] <- as.factor(aov_t_data[[i]][[j]][[attributes[j]]])
    formula_str_1 <- paste("S1_med ~", attributes[j])
    formula_1 <- as.formula(formula_str_1)
    anov_test_1[[i]][[j]] <- anova(aov(formula_1, data = aov_t_data[[i]][[j]]))
  }
}




```






ANOVA and Boxplot (Fig H.3)
```{r}


options(warn = -1)

attributes <- c("MUNI_TAX_PROV","Pricing_TYP", "CPN_range",
                "S_OID","Y_OID", "DAM", "CALLABLE", "Issued_Amt")

maturities <- c(" Less than 8", 
                "8_12.3", 
                "12.3_17", 
                "Higher than 17")

# Prepare data for all combinations
aov_t_data <- list()
for (i in 1:length(maturities)) {
  aov_t_data[[i]] <- vector("list", length(attributes))
  for (j in 1:length(attributes)) {
    aov_t_data[[i]][[j]] <- California %>%
      group_by(Date, Maturity_OID, !!sym(attributes[j])) %>%
      filter(Maturity_OID == maturities[i]) %>%
      summarise(S1_med = median(S1), .groups = 'drop') %>%
      ungroup()
  }
}

# Convert to dataframe
aov_t_data_df <- bind_rows(aov_t_data)

# Create all plots in a grid
plot_list <- list()
plot_counter <- 1

for (i in 1:length(attributes)) {  # Rows (attributes)
  for (j in 1:length(maturities)) {  # Columns (maturities)
    
    plot_data <- aov_t_data_df %>%
      dplyr::select(Date, Maturity_OID, S1_med, !!sym(attributes[i])) %>%
      filter(Maturity_OID == maturities[j]) %>%
      # Remove NA values from the attribute column first
      filter(!is.na(!!sym(attributes[i])) & !!sym(attributes[i]) != "NA") %>%
      # Then apply specific filtering for MUNI_TAX_PROV
      filter(if (attributes[i] == "MUNI_TAX_PROV") {
               (!!sym(attributes[i]) %in% c("FED TAXABLE/ST TAX-EXEMPT", "FED & ST TAX-EXEMPT"))
             } else {
               TRUE
             }) %>%
      # Final check to remove any remaining NAs
      drop_na(!!sym(attributes[i]))
    
    # Shorten tax labels
    if (attributes[i] == "MUNI_TAX_PROV") {
      plot_data <- plot_data %>%
        mutate(!!sym(attributes[i]) := case_when(
          !!sym(attributes[i]) == "FED TAXABLE/ST TAX-EXEMPT" ~ "Fed Taxable",
          !!sym(attributes[i]) == "FED & ST TAX-EXEMPT" ~ "Fed&State Exempt",
          TRUE ~ as.character(!!sym(attributes[i]))
        ))
    }
    
    if (nrow(plot_data) > 0) {
      p <- ggplot(plot_data, aes(x = !!sym(attributes[i]), y = S1_med, fill = !!sym(attributes[i]))) +
        geom_boxplot(alpha = 0.5, color = "black") +
        geom_point(shape = 21, size = 1.5, 
                   position = position_jitterdodge(jitter.width = 0.1, dodge.width = 0.75)) +
        geom_hline(yintercept = median(California$S1[California$Maturity_OID == maturities[j]], na.rm = TRUE), 
                   linetype = "dashed", color = "red", size = 0.8) + 
        geom_hline(yintercept = 0, linetype = "solid", color = "black", size = 0.3) +
        ylim(-2, 2) +
        labs(x = "",  # Remove x-label from all plots
             y = if(j == 1) "S1_med" else "",  # Only show y-label on first column
             title = if(i == 1) paste0("Maturity_OID: ", maturities[j]) else "") +  # Only show title on top row with prefix
        theme_minimal() +
        theme(
          panel.border = element_rect(color = "black", fill = NA, size = 0.5),
          axis.text.x = element_text(angle = 25, hjust = 1, size = 6), # Reduced angle and size
          axis.text.y = element_text(size = 8),
          axis.title = element_text(size = 9),
          plot.title = element_text(size = 10, hjust = 0.5, face = "bold"), # Bold title
          legend.position = "none",  # Remove individual legends
          plot.margin = margin(1, 1, 1, 1, "mm") # Reduced margins for bigger plots
        )
      
      # Add row labels (attribute names) on the left with bigger text
      if (j == 1) {
        p <- p + labs(y = paste0(attributes[i], "\n", "S1_med")) +
          theme(axis.title.y = element_text(size = 12, face = "bold")) # Bold attribute names
      }
      
    } else {
      # Create empty plot if no data
      p <- ggplot() + 
        theme_void() + 
        labs(title = if(i == 1) paste0("Maturity_OID: ", maturities[j]) else "")
    }
    
    plot_list[[plot_counter]] <- p
    plot_counter <- plot_counter + 1
  }
}

# Create the combined plot without main title
combined_plot <- grid.arrange(grobs = plot_list, 
                             nrow = length(attributes), 
                             ncol = length(maturities),
                             left = textGrob("Attributes", rot = 90, vjust = 1,
                                           gp = gpar(fontsize = 14, fontface = "bold")), # Bigger text
                             bottom = textGrob("Maturity Groups", 
                                             gp = gpar(fontsize = 12)))

# Restore warnings
options(warn = 0)

# Display the plot
print(combined_plot)

# ============ SAVING SECTION ============
# output_dir <- "..."
# plot_filename <- paste(output_dir, "S1_boxplots_grid_all_attributes_maturities.png", sep = "/")
# 
# ggsave(plot_filename, plot = combined_plot, 
#        width = 20, height = 24, units = "in", dpi = 300)
# =========================================================================
```



